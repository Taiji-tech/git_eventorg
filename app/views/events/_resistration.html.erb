<!--参加予約-->

<script>
$(function(){
  var attendForm = `
    <div id="event-attend-form">
    <div class="event-attend-form">
      <div class="event-attend__top">
        <h3>参加登録</h3>
        <p class="btn-hover" id="event-attend-form-close">&times;</p>
      </div>
      <% if flash["notice"].present? %>
        <p><%= flash["notice"] %></p>
      <% end %>
      
      <% if user_signed_in? %>
      <div class="">
        <p><span>ニックネーム</span></p>
        <p><span>E-mail</span></p>
      </div>
      <% else %>
      <div class="event-attend__select">
        <li class="blue-btn btn-hover" id="with-resistration">ユーザー登録も行う</li>
        <li class="unselect-btn btn-hover" id="without-resistration">ユーザー登録は行わない</li>
        <p>アカウントをすでにお持ちの方 <%= link_to "ログイン", user_session_path %></p>
      </div>
      <% end %>
      
      <div class="event-attend__detail">
        <h4>イベント詳細</h4>
        <div class="event-attend__detail-info">
          <table>
            <tr>
              <th>開催日時</th>
              <td><%= @event.start %></td>
            </tr>
            <tr>
              <th>開催場所</th>
              <td><%= @event.venue %></td>
            </tr>
            <tr>
              <th>定員</th>
              <td><%= @event.capacity %></td>
            </tr>
            <tr>
              <th>イベント主催者</th>
              <td><%= @event.user.nickname %></td>
            </tr>
          </table>
        </div>
        <div class="event-attend__form" id="event-attend__form-with">
        <%= form_with(model: @user, url: event_create_with_resistration_path(@event.id)) do |f| %>
          <div class="event-attend__form-box">
            <%= f.label:nickname, "ニックネーム" %>
            <%= f.text_field:nickname %>
          </div>
          <div class="event-attend__form-box">
            <%= f.label:email, "E-mail" %>
            <%= f.text_field:email %>
          </div>
          <div class="event-attend__form-box">
            <%= f.label :password, "パスワード" %>
            <% if @minimum_password_length %>
            <em>(<%= @minimum_password_length %> characters minimum)</em>
            <% end %>
            <%= f.password_field :password, autocomplete: "new-password" %>
          </div>
          <div class="event-attend__form-box">
            <%= f.label :password_confirmation, "パスワード（確認）" %>
            <%= f.password_field :password_confirmation, autocomplete: "new-password" %>
          </div>
          <div class="event-attend__submit-box">
            <%= f.submit "予約する" %>
          </div>
        <% end %>
        </div>
      </div>
    </div>
    </div>`
  
  // ユーザー登録込みのフォーム  
  var formWithResistration = `
    <div class="event-attend__form" id="event-attend__form-with">
    <%= form_with(model: @user, url: event_create_with_resistration_path(@event.id)) do |f| %>
      <div class="event-attend__form-box">
        <%= f.label:nickname, "ニックネーム" %>
        <%= f.text_field:nickname %>
      </div>
      <div class="event-attend__form-box">
        <%= f.label:email, "E-mail" %>
        <%= f.text_field:email %>
      </div>
      <div class="event-attend__form-box">
        <%= f.label :password, "パスワード" %>
        <% if @minimum_password_length %>
        <em>(<%= @minimum_password_length %> characters minimum)</em>
        <% end %>
        <%= f.password_field :password, autocomplete: "new-password" %>
      </div>
      <div class="event-attend__form-box">
        <%= f.label :password_confirmation, "パスワード（確認）" %>
        <%= f.password_field :password_confirmation, autocomplete: "new-password" %>
      </div>
      <div class="event-attend__submit-box">
        <%= f.submit "予約する" %>
      </div>
    <% end %>
    </div>`  
  
  // ユーザー登録なしのフォーム
  var formWithoutResistration = `
    <div class="event-attend__form" id="event-attend__form-without">
    <%= form_with(model: @reserve, url: event_reserves_path(@event.id)) do |f| %>
      <div class="event-attend__form-box">
        <%= f.label:nickname, "ニックネーム" %>
        <%= f.text_field:nickname %>
      </div>
      <div class="event-attend__form-box">
        <%= f.label:email, "E-mail" %>
        <%= f.email_field:email %>
      </div>
      <div class="event-attend__submit-box">
        <%= f.submit "予約する" %>
      </div>
    <% end %>
    </div>`
  
  
  
  
  $("#event-attend").on("click", function(){
    $.when(
      $("#display").animate({opacity: .8}, 300)
    ).done(function(){
      $("#event-attend").after(attendForm);
      $("#display").css("display", "");
      
      // closeボタンを押したとき
      $("#event-attend-form-close").on("click", function(){
        $.when(
          $("#display").animate({opacity: 0}, 300),
          $("#event-attend-form").animate({opacity: 0}, 300)
        ).done(function(){
          $("#event-attend-form").remove();
          $("#display").css("display", "none");
        }); 
      });
      
      
      // ユーザー登録も行うボタンを押したとき
      $("#with-resistration").on("click", function(){
        var className = $(this).attr("class");
        if(className.indexOf("unselect-btn") > -1){
          $(this).removeClass("unselect-btn");
          $(this).addClass("blue-btn");
          $("#without-resistration").removeClass("blue-btn");
          $("#without-resistration").addClass("unselect-btn");
          $("#event-attend__form-without").remove();
          $(".event-attend__detail").append(formWithResistration);
        }
      });
      
      // ユーザー登録は行わないボタンを押したとき
      $("#without-resistration").on("click", function(){
        var className = $(this).attr("class");
        if(className.indexOf("unselect-btn") > -1){
          $(this).removeClass("unselect-btn");
          $(this).addClass("blue-btn");
          $("#with-resistration").removeClass("blue-btn");
          $("#with-resistration").addClass("unselect-btn");
          $("#event-attend__form-with").remove();
          $(".event-attend__detail").append(formWithoutResistration);
        }
      });
    });
  });
});  
</script>