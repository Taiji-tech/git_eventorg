
<%= render "shared/flash" %>
<div class="container">
  <div class="row">
    <div class="col-12 col-sm-3">
      <%= render "shared/sidebar_organizer" %>
    </div>  
  
    <div class='col-12 col-sm-9 content'>
      <div class="page-title">
        <h1>イベント作成</h1>
      </div>
      
      <div class="event">
        <%= form_with(model: @event, url: events_path, method: :post, data: { remote: false }) do |f| %>
          <div class="event-form">
            <%= f.label:title, "イベント名" %>
            <%= f.text_field:title, class:"form-control form-control-lg" %>
          </div>
          <div class="event-form event-form-date">
            <%= f.label:start_date, "開催日時" %>
            <%= f.date_field:start_date, class:"form-control" %>
            <%= f.time_select:start_time, {}, class:"form-control", ignore_data:true %>
          </div>
          <div class="event-form">
            <%= f.label:content, "イベント内容" %>
            <%= f.text_area:content, class:"form-control form-control-lg event-form-content", placeholder: "開催するイベントの内容を書いてください" %>
          </div>
          <div class="event-form">
            <%= f.label:venue, "ズームID" %>
            <%= f.text_field:venue, class:"form-control form-control-lg" %>
          </div>
          <div class="event-form">
            <%= f.label:capacity, "定員" %>
            <%= f.number_field:capacity, class:"form-control form-control-lg" %>
          </div>
          <div class="event-form">
            <%= f.label:price, "費用" %>
            <%= f.number_field:price, class:"form-control form-control-lg" %>
          </div>
          <div class="event-form" id="event-form__img">
            <%= f.label:imgs, "画像" %>
            <label class="event-form__img-field" for="img-file"><i class="fa fa-image" aria-hidden="true"></i><br>クリックしてアップロード</label>
            <%= f.file_field:imgs, multiple: true, class:"", id:"img-file", style:"display:none" %>
          </div>
          <div class="event-submit">
            <%= f.submit "イベント作成", class:"submit-btn blue-btn btn-hover" %>
          </div>
        <% end %>
      </div>
    </div>
    
  </div>
</div>




<script>
$(function(){
  var dataBox = new DataTransfer();
  var file_field = document.querySelector('input[type=file]');
  $('#img-file').change(function(){
    var files = $('input[type="file"]').prop('files')[0];
    $.each(this.files, function(i, file){
      var fileReader = new FileReader();
      dataBox.items.add(file);
      file_field.files = dataBox.files
      var num = $('.item-image').length + 1 + i
      fileReader.readAsDataURL(file);

      if (num == 10){
        $('#image-box__container').css('display', 'none');   
      }
  
      fileReader.onloadend = function() {
        var src = fileReader.result
        var imgBox= 
          `<div class="event-form__img-wrap item-image" data-image="${file.name}">
            <div class="event-form__img-box">
              <img src=${src} class="event-form__img">
            </div>
            <div class="event-form__img-remove">
              <p><i class="fa fa-remove btn-hover" aria-hidden="true"></i></p>
            </div>
          </div>`
          
        $('#event-form__img').append(imgBox);
      };
      $('#image-box__container').attr('class', `item-num-${num}`);
    });
  });
  
  //削除関連
  $(document).on("click", '.event-form__img-remove', function(){
    var target_image = $(this).parent();
    var target_name = $(target_image).data('image')
    
    if(file_field.files.length == 1){
      ("input[type=file]").val(null);
      dataBox.clearData();
      console.log(dataBox);
    }else{
      
      $.each(file_field.files, function(i,input){
        if(input.name == target_name){
          dataBox.items.remove(i);
        }
      });
      file_field.files = dataBox.files
    }
    target_image.remove();
    var num = $('.item-image').length
    $('#image-box__container').show()
    $('#image-box__container').attr('class', `item-num-${num}`)
  })
});
</script>